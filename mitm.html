<script>
  let keepAlive = () => {
    keepAlive = () => {};
    var ping = location.href.substr(0, location.href.lastIndexOf('/')) + '/ping';
    var interval = setInterval(() => {
      if (serviceWorker) {
        serviceWorker.postMessage('ping');
      } else {
        fetch(ping).then(res => res.text(!res.ok && clearInterval(interval)));
      }
    }, 10000);
  };
  let scope = '';
  let serviceWorker = null;
  let tempMessageStore = [];
  window.onmessage = evt => tempMessageStore.push(evt);
  function registerWorker() {
    return navigator.serviceWorker.getRegistration('./')
      .then(serviceWorkerRegistration => {
        return serviceWorkerRegistration || navigator.serviceWorker.register('serviceWorker.js', { scope: './' });
      }).then(serviceWorkerRegistration => {
        scope = serviceWorkerRegistration.scope;
        if (serviceWorkerRegistration.active) {
          serviceWorker = serviceWorkerRegistration.active;
          return;
        }
        const swRegTmp = serviceWorkerRegistration.installing || serviceWorkerRegistration.waiting;
        return new Promise(resolve => {
          const onStatechange = () => {
            if (swRegTmp.state === 'activated') {
              swRegTmp.removeEventListener('statechange', onStatechange);
              serviceWorker = serviceWorkerRegistration.active;
              resolve();
            }
          };
          swRegTmp.addEventListener('statechange', onStatechange);
        });
      });
  }
  function onMessage(event) {
    let { data, ports, origin } = event;
    if (!ports || !ports.length) {
      throw new TypeError("[StreamSaver] You didn't send a messageChannel");
    }
    if (typeof data !== 'object') {
      throw new TypeError("[StreamSaver] You didn't send a object");
    }
    if (data.readableStream) {
    }
    if (!data.pathname) {
      data.pathname = Math.random().toString().slice(-6) + '/' + data.filename;
    }
    if (!data.headers) {
    } else {
      new Headers(data.headers);
    }
    data.origin = origin;
    data.referrer = data.referrer || document.referrer || origin;
    data.pathname = data.pathname.replace(/^\/+/g, '');
    let org = origin.replace(/(^\w+:|^)\/\//, '');
    data.url = new URL(`${scope + org}/${data.pathname}`).toString();
    if (!data.url.startsWith(`${scope + org}/`)) {
      throw new TypeError('[StreamSaver] bad `data.pathname`');
    }
    const transferable = data.readableStream ? [ports[0], data.readableStream] : [ports[0]];
    if (!(data.readableStream || data.transferringReadable)) {
      keepAlive();
    }
    return serviceWorker.postMessage(data, transferable);
  }
  if (window.opener) {
    window.opener.postMessage('StreamSaver::loadedPopup', '*');
  }
  if (navigator.serviceWorker) {
    registerWorker().then(() => {
      window.onmessage = onMessage;
      tempMessageStore.forEach(window.onmessage);
    });
  } else {
    keepAlive();
  }
</script>
